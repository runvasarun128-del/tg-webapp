<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitch Giveaway WebApp</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@500;600&display=swap");
    :root {
      --bg: #0c1016;
      --card: #111827;
      --line: #1b2433;
      --text: #e8eef8;
      --muted: #9eafc3;
      --accent: #5eead4;
      --accent-2: #7c5bff;
      --danger: #ff7b8b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Manrope", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(120% 120% at 15% 0%, #152033 0%, #0c1016 45%, #080c12 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .shell { width: min(980px, 100%); display: grid; gap: 14px; }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 18px 50px #00000055;
    }
    .auth { text-align: center; padding: 28px; display: grid; gap: 12px; }
    .title { margin: 0; font-size: 22px; font-weight: 700; }
    .muted { color: var(--muted); margin: 0; }
    .button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      color: #0c1016;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 12px 30px #00000055;
      transition: transform 120ms ease;
    }
    .button:active { transform: translateY(1px) scale(0.99); }
    .button.ghost {
      background: #0d1522;
      color: var(--text);
      border: 1px solid var(--line);
      box-shadow: none;
    }
    .grid { display: grid; gap: 14px; }
    .profile { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; }
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 14px;
      background: linear-gradient(135deg, #192438, #0f1624);
      border: 1px solid var(--line);
      display: grid;
      place-items: center;
      font-weight: 700;
      overflow: hidden;
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .chips { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .chip {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #0d1522;
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
    }
    .section { display: grid; gap: 10px; }
    .section h3 { margin: 0; font-size: 15px; font-weight: 700; display: flex; align-items: center; justify-content: space-between; }
    .list { display: grid; gap: 10px; }
    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background: #0f1724;
      border: 1px solid var(--line);
    }
    .row .meta { color: var(--muted); font-size: 13px; margin-top: 2px; }
    .pill {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0d1522;
      font-weight: 700;
      font-size: 12px;
      color: var(--text);
    }
    .pill.positive { background: #10261d; color: #7ff2c4; border-color: #1a6546; }
    .pill.bad { background: #2a1216; color: var(--danger); border-color: #4f1f28; }
    .row-actions { display: flex; gap: 8px; align-items: center; }
    .checkbox { width: 18px; height: 18px; accent-color: var(--accent); }
    .input, .select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0d1522;
      color: var(--text);
      font-size: 13px;
    }
    .hidden { display: none; }
    .error {
      color: #ff8a8a;
      background: #2a1313;
      border: 1px solid #4d2020;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      text-align: left;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card auth" id="authCard">
      <h1 class="title">Авторизация через Twitch</h1>
      <p class="muted">Подтверди аккаунт, чтобы участвовать в розыгрыше.</p>
      <div class="error hidden" id="authError"></div>
      <button class="button" id="connectBtn">Войти через Twitch</button>
    </div>

    <div class="grid hidden" id="appContent">
      <div class="card">
        <div class="profile">
          <div class="avatar" id="avatar"><img id="avatarImg" alt="avatar"><span id="avatarText">TW</span></div>
          <div>
            <p class="title" id="displayName">twitch_user</p>
            <p class="muted" id="username">@not_connected</p>
          </div>
          <button class="button ghost" id="refreshBtn">Обновить</button>
        </div>
        <div class="chips">
          <div class="chip">Розыгрыш: <span id="giveawayStatus">не активен</span></div>
          <div class="chip">Старт: <span id="startTimer">--:--</span></div>
          <div class="chip">Участников: <span id="participantCount">0</span></div>
          <div class="chip">Условия: <span id="conditionStatus">не выполнены</span></div>
        </div>
      </div>

      <div class="card section">
        <h3>Стримы</h3>
        <div class="list" id="streamers"></div>
      </div>

      <div class="card section">
        <h3>Условия участия</h3>
        <div class="list">
          <label class="row">
            <div>
              <div>Подписка на Twitch obn4l</div>
              <div class="meta"><a href="https://www.twitch.tv/obn4l" target="_blank" rel="noreferrer">Открыть канал</a></div>
            </div>
            <input class="checkbox" type="checkbox" id="condTwitch">
          </label>
          <label class="row">
            <div>
              <div>Подписка на Telegram канал</div>
              <div class="meta"><a href="https://t.me/+V_zpVgCzNDA0ZTUy" target="_blank" rel="noreferrer">Открыть канал</a></div>
            </div>
            <input class="checkbox" type="checkbox" id="condTelegram">
          </label>
          <div class="row">
            <div>
              <div>Сообщений в чате (минимум: <span id="minMessagesLabel">10</span>)</div>
              <div class="meta">Введите количество сообщений, которые вы написали.</div>
            </div>
            <input class="input" type="number" min="0" id="condMessages" value="0">
          </div>
          <div class="row">
            <div>
              <div>Выберите редкость</div>
              <div class="meta">Нужно выбрать редкость для участия.</div>
            </div>
            <select class="select" id="condRarity"></select>
          </div>
        </div>
        <div class="row-actions">
          <div class="pill" id="conditionPill">Условия не выполнены</div>
          <button class="button ghost" id="checkBtn">Проверить условия</button>
          <button class="button ghost" id="joinBtn">Участвовать</button>
        </div>
      </div>

      <div class="card section hidden" id="adminCard">
        <h3>Админка obn4l</h3>
        <div class="row">
          <div>
            <div>Управление розыгрышем</div>
            <div class="meta" id="adminStatus">не активен</div>
          </div>
          <div class="row-actions">
            <button class="button ghost" id="startGiveaway">Начать</button>
            <button class="button ghost" id="stopGiveaway">Остановить</button>
          </div>
        </div>
        <div class="row">
          <div>
            <div>Минимум сообщений</div>
            <div class="meta">Требование для участия</div>
          </div>
          <input class="input" type="number" min="0" id="adminMinMessages">
        </div>
        <div class="row">
          <div>
            <div>Требуемая редкость</div>
            <div class="meta">Любая или конкретная</div>
          </div>
          <select class="select" id="adminRarity"></select>
        </div>
        <div class="list" id="participantList"></div>
        <div class="muted hidden" id="emptyParticipants">Пока участников нет.</div>
      </div>
    </div>
  </div>

  <script>
    const TWITCH_CHANNEL = { name: "obn4l", login: "obn4l", url: "https://www.twitch.tv/obn4l" };
    const TWITCH_CLIENT_ID = "jzooqv09s44tt89ds1uv65t0yowa44";
    const TWITCH_TOKEN_KEY = "twitch-access-token";

    const rarities = [
      { key: "any", name: "\u041b\u044e\u0431\u0430\u044f" },
      { key: "common", name: "\u041e\u0431\u044b\u0447\u043d\u043e\u0435" },
      { key: "uncommon", name: "\u041d\u0435\u043e\u0431\u044b\u0447\u043d\u043e\u0435" },
      { key: "rare", name: "\u0420\u0435\u0434\u043a\u043e\u0435" },
      { key: "very-rare", name: "\u041e\u0447\u0435\u043d\u044c \u0440\u0435\u0434\u043a\u043e\u0435" },
      { key: "epic", name: "\u042d\u043f\u0438\u0447\u0435\u0441\u043a\u043e\u0435" },
      { key: "legendary", name: "\u041b\u0435\u0433\u0435\u043d\u0434\u0430\u0440\u043d\u043e\u0435" },
      { key: "mythic", name: "\u041c\u0438\u0444\u0438\u0447\u0435\u0441\u043a\u043e\u0435" },
    ];

    const streams = [
      { name: TWITCH_CHANNEL.name, platform: "Twitch", link: TWITCH_CHANNEL.url, status: "LIVE", viewers: 1240, game: "Giveaway & Chat" },
    ];

    const state = {
      user: null,
      giveawayActive: false,
      giveawayStart: 0,
      requiredRarity: "any",
      minMessages: 10,
      participants: [],
      conditions: { twitch: false, telegram: false, messages: 0, rarity: "" },
    };

    function formatTime(sec) {
      const m = Math.max(0, Math.floor(sec / 60)).toString().padStart(2, "0");
      const s = Math.max(0, Math.floor(sec % 60)).toString().padStart(2, "0");
      return `${m}:${s}`;
    }

    async function api(path, options = {}) {
      const res = await fetch(path, {
        headers: { "Content-Type": "application/json" },
        ...options,
      });
      const data = await res.json();
      if (!res.ok) throw data;
      return data;
    }

    function renderStreams() {
      const root = document.getElementById("streamers");
      root.innerHTML = "";
      streams.forEach((s) => {
        const row = document.createElement("div");
        row.className = "row";
        const left = document.createElement("div");
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = s.name;
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${s.platform} ? ${s.game} ? ${s.viewers} зрителей`;
        left.append(title, meta);
        const action = document.createElement("a");
        action.className = "button ghost";
        action.href = s.link;
        action.target = "_blank";
        action.rel = "noreferrer";
        action.textContent = "Открыть";
        row.append(left, action);
        root.appendChild(row);
      });
    }

    function conditionsOk() {
      const msgOk = state.conditions.messages >= state.minMessages;
      const rarityOk = state.conditions.rarity && (state.requiredRarity === "any" || state.conditions.rarity === state.requiredRarity);
      return state.conditions.twitch && state.conditions.telegram && msgOk && rarityOk;
    }

    function renderStats() {
      document.getElementById("giveawayStatus").textContent = state.giveawayActive ? "активен" : "не активен";
      document.getElementById("participantCount").textContent = state.participants.length;
      document.getElementById("conditionStatus").textContent = conditionsOk() ? "выполнены" : "не выполнены";
    }

    function renderTimer() {
      const timer = document.getElementById("startTimer");
      if (!state.giveawayActive || !state.giveawayStart) {
        timer.textContent = "--:--";
        return;
      }
      const diff = Math.floor((state.giveawayStart - Date.now()) / 1000);
      if (diff > 0) {
        timer.textContent = `\u0447\u0435\u0440\u0435\u0437 ${formatTime(diff)}`;
      } else {
        timer.textContent = "\u0438\u0434\u0435\u0442";
      }
    }

    function renderConditions() {
      document.getElementById("condTwitch").checked = state.conditions.twitch;
      document.getElementById("condTelegram").checked = state.conditions.telegram;
      document.getElementById("condMessages").value = String(state.conditions.messages || 0);
      document.getElementById("minMessagesLabel").textContent = String(state.minMessages);

      const raritySelect = document.getElementById("condRarity");
      if (!raritySelect.options.length) {
        rarities.filter(r => r.key !== "any").forEach((r) => {
          const option = document.createElement("option");
          option.value = r.key;
          option.textContent = r.name;
          raritySelect.appendChild(option);
        });
      }
      raritySelect.value = state.conditions.rarity || "";

      const pill = document.getElementById("conditionPill");
      if (conditionsOk()) {
        pill.classList.add("positive");
        pill.classList.remove("bad");
        pill.textContent = "Условия выполнены";
      } else {
        pill.classList.remove("positive");
        pill.classList.add("bad");
        pill.textContent = "Условия не выполнены";
      }
      const joinBtn = document.getElementById("joinBtn");
      joinBtn.disabled = !state.giveawayActive || !conditionsOk();
      joinBtn.style.opacity = joinBtn.disabled ? "0.6" : "1";
    }

    function renderAdminSettings() {
      document.getElementById("adminMinMessages").value = String(state.minMessages);
      const adminSelect = document.getElementById("adminRarity");
      if (!adminSelect.options.length) {
        rarities.forEach((r) => {
          const option = document.createElement("option");
          option.value = r.key;
          option.textContent = r.name;
          adminSelect.appendChild(option);
        });
      }
      adminSelect.value = state.requiredRarity;
      document.getElementById("adminStatus").textContent = state.giveawayActive ? "активен" : "не активен";
    }

    function renderParticipants() {
      const list = document.getElementById("participantList");
      const empty = document.getElementById("emptyParticipants");
      list.innerHTML = "";
      empty.classList.toggle("hidden", state.participants.length > 0);
      state.participants.forEach((p) => {
        const row = document.createElement("div");
        row.className = "row";
        const left = document.createElement("div");
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = p.name || p.login || p.id;
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${p.login || p.id} ? Twitch: ${p.conditions.twitch ? "да" : "нет"} ? TG: ${p.conditions.telegram ? "да" : "нет"} ? Сообщений: ${p.conditions.messages} ? Редкость: ${p.conditions.rarity || "-"}`;
        left.append(title, meta);
        const status = document.createElement("div");
        status.className = "pill";
        status.textContent = p.joinedAt ? new Date(p.joinedAt).toLocaleString("ru-RU") : "";
        row.append(left, status);
        list.appendChild(row);
      });
    }

    function isAdmin() {
      return state.user && state.user.login && state.user.login.toLowerCase() === "obn4l";
    }

    async function joinGiveaway() {
      if (!state.user || !state.giveawayActive || !conditionsOk()) return;
      try {
        await api("/api/join", {
          method: "POST",
          body: JSON.stringify({
            user: { id: state.user.login, login: state.user.login, name: state.user.displayName },
            conditions: { ...state.conditions },
          }),
        });
        await refreshParticipants();
      } catch (e) {
        showAuthError("Условия не выполнены или розыгрыш не активен.");
      }
    }

    function connectTwitch() {
      const redirect = `${location.origin}${location.pathname}`;
      const stateToken = Math.random().toString(36).slice(2);
      localStorage.setItem("twitch-oauth-state", stateToken);
      const params = new URLSearchParams({
        client_id: TWITCH_CLIENT_ID,
        redirect_uri: redirect,
        response_type: "token",
        scope: "user:read:email",
        state: stateToken,
      });
      window.location.href = `https://id.twitch.tv/oauth2/authorize?${params.toString()}`;
    }

    function showAuthError(message) {
      const errorBox = document.getElementById("authError");
      errorBox.textContent = message;
      errorBox.classList.remove("hidden");
    }

    async function fetchTwitchUser(token) {
      const res = await fetch("https://api.twitch.tv/helix/users", {
        headers: { Authorization: `Bearer ${token}`, "Client-Id": TWITCH_CLIENT_ID },
      });
      if (!res.ok) throw new Error(`twitch ${res.status}`);
      const data = await res.json();
      const u = data.data?.[0];
      if (!u) throw new Error("no user");
      const name = u.display_name || u.login;
      const username = u.login ? `@${u.login}` : u.id;
      const avatarText = (u.login || name || "TW").slice(0, 2).toUpperCase();
      return { displayName: name, username, avatarText, avatarUrl: u.profile_image_url, login: u.login };
    }

    async function tryRestoreTwitchToken() {
      const hash = window.location.hash.replace("#", "");
      const hashParams = new URLSearchParams(hash);
      const errorBox = document.getElementById("authError");
      errorBox.classList.add("hidden");
      errorBox.textContent = "";

      if (hashParams.has("access_token")) {
        const token = hashParams.get("access_token");
        const stateFromHash = hashParams.get("state");
        const storedState = localStorage.getItem("twitch-oauth-state");
        if (storedState && stateFromHash === storedState) {
          localStorage.setItem(TWITCH_TOKEN_KEY, token);
          history.replaceState(null, "", location.pathname + location.search);
        }
      } else if (hashParams.has("error")) {
        const err = hashParams.get("error");
        const desc = hashParams.get("error_description") || "";
        errorBox.textContent = `Twitch OAuth error: ${err}\n${decodeURIComponent(desc)}`;
        errorBox.classList.remove("hidden");
      }
      const token = localStorage.getItem(TWITCH_TOKEN_KEY);
      if (!token) return;
      try {
        const user = await fetchTwitchUser(token);
        state.user = user;
        applyUser();
      } catch (e) {
        console.warn("Twitch token invalid", e);
        localStorage.removeItem(TWITCH_TOKEN_KEY);
        errorBox.textContent = "Не удалось проверить токен Twitch. Попробуйте войти снова.";
        errorBox.classList.remove("hidden");
      }
    }

    function applyUser() {
      if (!state.user) return;
      document.getElementById("displayName").textContent = state.user.displayName;
      document.getElementById("username").textContent = state.user.username;
      const avatarImg = document.getElementById("avatarImg");
      const avatarText = document.getElementById("avatarText");
      if (state.user.avatarUrl) {
        avatarImg.src = state.user.avatarUrl;
        avatarImg.style.display = "block";
        avatarText.style.display = "none";
      } else {
        avatarImg.style.display = "none";
        avatarText.style.display = "inline";
        avatarText.textContent = state.user.avatarText || "TW";
      }
      document.getElementById("authCard").classList.add("hidden");
      document.getElementById("appContent").classList.remove("hidden");
      renderStreams();
      refreshState();
    }

    async function refreshState() {
      try {
        const data = await api("/api/state");
        state.giveawayActive = data.active;
        state.giveawayStart = data.startAt;
        state.requiredRarity = data.requiredRarity;
        state.minMessages = data.minMessages;
      } catch (e) {
        console.warn("state fetch failed", e);
      }
      renderConditions();
      renderStats();
      renderTimer();
      renderAdminSettings();
      await refreshParticipants();
      document.getElementById("adminCard").classList.toggle("hidden", !isAdmin());
    }

    async function refreshParticipants() {
      try {
        const data = await api("/api/participants");
        state.participants = data.participants || [];
      } catch (e) {
        console.warn("participants fetch failed", e);
      }
      renderParticipants();
      renderStats();
    }

    function init() {
      document.getElementById("connectBtn").addEventListener("click", connectTwitch);
      document.getElementById("refreshBtn").addEventListener("click", () => {
        refreshState();
      });
      document.getElementById("condTwitch").addEventListener("change", (e) => {
        state.conditions.twitch = e.target.checked;
        renderConditions();
      });
      document.getElementById("condTelegram").addEventListener("change", (e) => {
        state.conditions.telegram = e.target.checked;
        renderConditions();
      });
      document.getElementById("condMessages").addEventListener("input", (e) => {
        state.conditions.messages = Number(e.target.value) || 0;
        renderConditions();
      });
      document.getElementById("condRarity").addEventListener("change", (e) => {
        state.conditions.rarity = e.target.value;
        renderConditions();
      });
      document.getElementById("checkBtn").addEventListener("click", () => {
        renderConditions();
      });
      document.getElementById("joinBtn").addEventListener("click", joinGiveaway);
      document.getElementById("startGiveaway").addEventListener("click", async () => {
        if (!isAdmin()) return;
        await api("/api/admin/start", {
          method: "POST",
          body: JSON.stringify({
            startDelaySec: 30,
            requiredRarity: state.requiredRarity,
            minMessages: state.minMessages,
          }),
        });
        refreshState();
      });
      document.getElementById("stopGiveaway").addEventListener("click", async () => {
        if (!isAdmin()) return;
        await api("/api/admin/stop", { method: "POST", body: "{}" });
        refreshState();
      });
      document.getElementById("adminMinMessages").addEventListener("input", async (e) => {
        state.minMessages = Number(e.target.value) || 0;
        await api("/api/admin/settings", {
          method: "POST",
          body: JSON.stringify({ requiredRarity: state.requiredRarity, minMessages: state.minMessages }),
        });
        renderConditions();
        renderAdminSettings();
      });
      document.getElementById("adminRarity").addEventListener("change", async (e) => {
        state.requiredRarity = e.target.value;
        await api("/api/admin/settings", {
          method: "POST",
          body: JSON.stringify({ requiredRarity: state.requiredRarity, minMessages: state.minMessages }),
        });
        renderConditions();
        renderAdminSettings();
      });
      renderStreams();
      renderConditions();
      renderStats();
      renderTimer();
      renderAdminSettings();
      tryRestoreTwitchToken();
      setInterval(renderTimer, 1000);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
