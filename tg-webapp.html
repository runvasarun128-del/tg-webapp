<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitch Giveaway WebApp</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@500;600&display=swap");
    :root {
      --bg: #0c1016;
      --card: #111827;
      --line: #1b2433;
      --text: #e8eef8;
      --muted: #9eafc3;
      --accent: #5eead4;
      --accent-2: #7c5bff;
      --danger: #ff7b8b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Manrope", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: radial-gradient(120% 120% at 15% 0%, #152033 0%, #0c1016 45%, #080c12 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .shell {
      width: min(960px, 100%);
      display: grid;
      gap: 14px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 18px 50px #00000055;
    }
    .auth {
      text-align: center;
      padding: 28px;
      display: grid;
      gap: 12px;
    }
    .title { margin: 0; font-size: 22px; font-weight: 700; }
    .muted { color: var(--muted); margin: 0; }
    .button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      color: #0c1016;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow: 0 12px 30px #00000055;
      transition: transform 120ms ease;
    }
    .button:active { transform: translateY(1px) scale(0.99); }
    .button.ghost {
      background: #0d1522;
      color: var(--text);
      border: 1px solid var(--line);
      box-shadow: none;
    }
    .grid { display: grid; gap: 14px; }
    .profile {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
    }
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 14px;
      background: linear-gradient(135deg, #192438, #0f1624);
      border: 1px solid var(--line);
      display: grid;
      place-items: center;
      font-weight: 700;
      overflow: hidden;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .chips {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .chip {
      padding: 8px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #0d1522;
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
    }
    .section { display: grid; gap: 10px; }
    .section h3 {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .list { display: grid; gap: 10px; }
    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background: #0f1724;
      border: 1px solid var(--line);
    }
    .row label { cursor: pointer; }
    .row .meta { color: var(--muted); font-size: 13px; margin-top: 2px; }
    .pill {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #0d1522;
      font-weight: 700;
      font-size: 12px;
      color: var(--text);
    }
    .pill.positive { background: #10261d; color: #7ff2c4; border-color: #1a6546; }
    .pill.bad { background: #2a1216; color: var(--danger); border-color: #4f1f28; }
    .row-actions { display: flex; gap: 8px; align-items: center; }
    .checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }
    .hidden { display: none; }
    .error {
      color: #ff8a8a;
      background: #2a1313;
      border: 1px solid #4d2020;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      text-align: left;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card auth" id="authCard">
      <h1 class="title">Авторизация через Twitch</h1>
      <p class="muted">Подтверди аккаунт, чтобы участвовать в розыгрыше.</p>
      <div class="error hidden" id="authError"></div>
      <button class="button" id="connectBtn">Войти через Twitch</button>
    </div>

    <div class="grid hidden" id="appContent">
      <div class="card">
        <div class="profile">
          <div class="avatar" id="avatar"><img id="avatarImg" alt="avatar"><span id="avatarText">TW</span></div>
          <div>
            <p class="title" id="displayName">twitch_user</p>
            <p class="muted" id="username">@not_connected</p>
          </div>
          <button class="button ghost" id="refreshBtn">Обновить</button>
        </div>
        <div class="chips">
          <div class="chip">Розыгрыш: <span id="giveawayStatus">не активен</span></div>
          <div class="chip">Участников: <span id="participantCount">0</span></div>
          <div class="chip">Условия: <span id="conditionStatus">не выполнены</span></div>
        </div>
      </div>

      <div class="card section">
        <h3>Стримы</h3>
        <div class="list" id="streamers"></div>
      </div>

      <div class="card section">
        <h3>Условия участия</h3>
        <div class="list">
          <label class="row">
            <div>
              <div>Подписка на Twitch obn4l</div>
              <div class="meta"><a href="https://www.twitch.tv/obn4l" target="_blank" rel="noreferrer">Открыть канал</a></div>
            </div>
            <input class="checkbox" type="checkbox" id="condTwitch">
          </label>
          <label class="row">
            <div>
              <div>Подписка на Telegram канал</div>
              <div class="meta"><a href="https://t.me/+V_zpVgCzNDA0ZTUy" target="_blank" rel="noreferrer">Открыть канал</a></div>
            </div>
            <input class="checkbox" type="checkbox" id="condTelegram">
          </label>
        </div>
        <div class="row-actions">
          <div class="pill" id="conditionPill">Не выполнены</div>
          <button class="button ghost" id="joinBtn">Участвовать</button>
        </div>
      </div>

      <div class="card section hidden" id="adminCard">
        <h3>Админка obn4l</h3>
        <div class="row">
          <div>
            <div>Управление розыгрышем</div>
            <div class="meta" id="adminStatus">не активен</div>
          </div>
          <div class="row-actions">
            <button class="button ghost" id="startGiveaway">Начать</button>
            <button class="button ghost" id="stopGiveaway">Остановить</button>
          </div>
        </div>
        <div class="list" id="participantList"></div>
        <div class="muted hidden" id="emptyParticipants">Пока участников нет.</div>
      </div>
    </div>
  </div>

  <script>
    const TWITCH_CHANNEL = { name: "obn4l", login: "obn4l", url: "https://www.twitch.tv/obn4l" };
    const TELEGRAM_CHANNEL_URL = "https://t.me/+V_zpVgCzNDA0ZTUy";
    const TWITCH_CLIENT_ID = "jzooqv09s44tt89ds1uv65t0yowa44";
    const TWITCH_TOKEN_KEY = "twitch-access-token";

    const GIVEAWAY_ACTIVE_KEY = "giveaway-active";
    const PARTICIPANTS_KEY = "giveaway-participants";
    const CONDITIONS_PREFIX = "giveaway-conditions:";

    const streams = [
      { name: TWITCH_CHANNEL.name, platform: "Twitch", link: TWITCH_CHANNEL.url, status: "LIVE", viewers: 1240, game: "Giveaway & Chat" },
    ];

    const state = {
      user: null,
      giveawayActive: loadGiveawayState(),
      participants: loadParticipants(),
      conditions: { twitch: false, telegram: false },
    };

    function loadGiveawayState() {
      try { return localStorage.getItem(GIVEAWAY_ACTIVE_KEY) === "1"; } catch (_) { return false; }
    }
    function saveGiveawayState() {
      localStorage.setItem(GIVEAWAY_ACTIVE_KEY, state.giveawayActive ? "1" : "0");
    }
    function loadParticipants() {
      try {
        const raw = localStorage.getItem(PARTICIPANTS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (_) { return []; }
    }
    function saveParticipants() {
      localStorage.setItem(PARTICIPANTS_KEY, JSON.stringify(state.participants));
    }
    function userKey() {
      if (!state.user) return "unknown";
      return state.user.login || state.user.username || state.user.displayName || "unknown";
    }
    function loadConditions() {
      try {
        const raw = localStorage.getItem(`${CONDITIONS_PREFIX}${userKey()}`);
        return raw ? JSON.parse(raw) : { twitch: false, telegram: false };
      } catch (_) { return { twitch: false, telegram: false }; }
    }
    function saveConditions() {
      localStorage.setItem(`${CONDITIONS_PREFIX}${userKey()}`, JSON.stringify(state.conditions));
    }

    function formatAmount(n) { return n.toLocaleString("ru-RU"); }

    function renderStreams() {
      const root = document.getElementById("streamers");
      root.innerHTML = "";
      streams.forEach((s) => {
        const row = document.createElement("div");
        row.className = "row";
        const left = document.createElement("div");
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = s.name;
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${s.platform} • ${s.game} • ${s.viewers} зрителей`;
        left.append(title, meta);
        const action = document.createElement("a");
        action.className = "button ghost";
        action.href = s.link;
        action.target = "_blank";
        action.rel = "noreferrer";
        action.textContent = "Открыть";
        row.append(left, action);
        root.appendChild(row);
      });
    }

    function renderStats() {
      document.getElementById("giveawayStatus").textContent = state.giveawayActive ? "активен" : "не активен";
      document.getElementById("participantCount").textContent = state.participants.length;
      document.getElementById("conditionStatus").textContent = conditionsOk() ? "выполнены" : "не выполнены";
    }

    function conditionsOk() {
      return state.conditions.twitch && state.conditions.telegram;
    }

    function renderConditions() {
      document.getElementById("condTwitch").checked = state.conditions.twitch;
      document.getElementById("condTelegram").checked = state.conditions.telegram;
      const pill = document.getElementById("conditionPill");
      if (conditionsOk()) {
        pill.classList.add("positive");
        pill.classList.remove("bad");
        pill.textContent = "Условия выполнены";
      } else {
        pill.classList.remove("positive");
        pill.classList.add("bad");
        pill.textContent = "Условия не выполнены";
      }
      const joinBtn = document.getElementById("joinBtn");
      joinBtn.disabled = !state.giveawayActive || !conditionsOk();
      joinBtn.style.opacity = joinBtn.disabled ? "0.6" : "1";
    }

    function renderParticipants() {
      const list = document.getElementById("participantList");
      const empty = document.getElementById("emptyParticipants");
      list.innerHTML = "";
      empty.classList.toggle("hidden", state.participants.length > 0);
      state.participants.forEach((p) => {
        const row = document.createElement("div");
        row.className = "row";
        const left = document.createElement("div");
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = p.name || p.login || p.id;
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${p.login || p.id} • Twitch: ${p.conditions.twitch ? "да" : "нет"} • TG: ${p.conditions.telegram ? "да" : "нет"}`;
        left.append(title, meta);
        const status = document.createElement("div");
        status.className = "pill";
        status.textContent = p.joinedAt ? new Date(p.joinedAt).toLocaleString("ru-RU") : "";
        row.append(left, status);
        list.appendChild(row);
      });
    }

    function isAdmin() {
      return state.user && state.user.login && state.user.login.toLowerCase() === "obn4l";
    }

    function joinGiveaway() {
      if (!state.user || !state.giveawayActive || !conditionsOk()) return;
      const id = userKey();
      const exists = state.participants.some((p) => p.id === id);
      if (exists) return;
      state.participants.push({
        id,
        name: state.user.displayName,
        login: state.user.login,
        conditions: { ...state.conditions },
        joinedAt: Date.now(),
      });
      saveParticipants();
      renderParticipants();
      renderStats();
    }

    function connectTwitch() {
      const redirect = `${location.origin}${location.pathname}`;
      const stateToken = Math.random().toString(36).slice(2);
      localStorage.setItem("twitch-oauth-state", stateToken);
      const params = new URLSearchParams({
        client_id: TWITCH_CLIENT_ID,
        redirect_uri: redirect,
        response_type: "token",
        scope: "user:read:email",
        state: stateToken,
      });
      window.location.href = `https://id.twitch.tv/oauth2/authorize?${params.toString()}`;
    }

    function showAuthError(message) {
      const errorBox = document.getElementById("authError");
      errorBox.textContent = message;
      errorBox.classList.remove("hidden");
    }

    async function fetchTwitchUser(token) {
      const res = await fetch("https://api.twitch.tv/helix/users", {
        headers: {
          Authorization: `Bearer ${token}`,
          "Client-Id": TWITCH_CLIENT_ID,
        },
      });
      if (!res.ok) throw new Error(`twitch ${res.status}`);
      const data = await res.json();
      const u = data.data?.[0];
      if (!u) throw new Error("no user");
      const name = u.display_name || u.login;
      const username = u.login ? `@${u.login}` : u.id;
      const avatarText = (u.login || name || "TW").slice(0, 2).toUpperCase();
      return { displayName: name, username, avatarText, avatarUrl: u.profile_image_url, login: u.login };
    }

    async function tryRestoreTwitchToken() {
      const hash = window.location.hash.replace("#", "");
      const hashParams = new URLSearchParams(hash);
      const errorBox = document.getElementById("authError");
      errorBox.classList.add("hidden");
      errorBox.textContent = "";

      if (hashParams.has("access_token")) {
        const token = hashParams.get("access_token");
        const stateFromHash = hashParams.get("state");
        const storedState = localStorage.getItem("twitch-oauth-state");
        if (storedState && stateFromHash === storedState) {
          localStorage.setItem(TWITCH_TOKEN_KEY, token);
          history.replaceState(null, "", location.pathname + location.search);
        }
      } else if (hashParams.has("error")) {
        const err = hashParams.get("error");
        const desc = hashParams.get("error_description") || "";
        errorBox.textContent = `Twitch OAuth error: ${err}\n${decodeURIComponent(desc)}`;
        errorBox.classList.remove("hidden");
      }
      const token = localStorage.getItem(TWITCH_TOKEN_KEY);
      if (!token) return;
      try {
        const user = await fetchTwitchUser(token);
        state.user = user;
        applyUser();
      } catch (e) {
        console.warn("Twitch token invalid", e);
        localStorage.removeItem(TWITCH_TOKEN_KEY);
        errorBox.textContent = "Не удалось проверить токен Twitch. Попробуйте войти снова.";
        errorBox.classList.remove("hidden");
      }
    }

    function applyUser() {
      if (!state.user) return;
      document.getElementById("displayName").textContent = state.user.displayName;
      document.getElementById("username").textContent = state.user.username;
      const avatarImg = document.getElementById("avatarImg");
      const avatarText = document.getElementById("avatarText");
      if (state.user.avatarUrl) {
        avatarImg.src = state.user.avatarUrl;
        avatarImg.style.display = "block";
        avatarText.style.display = "none";
      } else {
        avatarImg.style.display = "none";
        avatarText.style.display = "inline";
        avatarText.textContent = state.user.avatarText || "TW";
      }
      document.getElementById("authCard").classList.add("hidden");
      document.getElementById("appContent").classList.remove("hidden");
      state.conditions = loadConditions();
      renderConditions();
      renderStats();
      renderStreams();
      renderParticipants();

      const adminCard = document.getElementById("adminCard");
      adminCard.classList.toggle("hidden", !isAdmin());
      document.getElementById("adminStatus").textContent = state.giveawayActive ? "активен" : "не активен";
    }

    function init() {
      document.getElementById("connectBtn").addEventListener("click", connectTwitch);
      document.getElementById("refreshBtn").addEventListener("click", () => {
        state.participants = loadParticipants();
        state.giveawayActive = loadGiveawayState();
        renderStats();
        renderParticipants();
      });
      document.getElementById("condTwitch").addEventListener("change", (e) => {
        state.conditions.twitch = e.target.checked;
        saveConditions();
        renderConditions();
        renderStats();
      });
      document.getElementById("condTelegram").addEventListener("change", (e) => {
        state.conditions.telegram = e.target.checked;
        saveConditions();
        renderConditions();
        renderStats();
      });
      document.getElementById("joinBtn").addEventListener("click", joinGiveaway);
      document.getElementById("startGiveaway").addEventListener("click", () => {
        if (!isAdmin()) return;
        state.giveawayActive = true;
        state.participants = [];
        saveGiveawayState();
        saveParticipants();
        renderStats();
        renderParticipants();
        document.getElementById("adminStatus").textContent = "активен";
      });
      document.getElementById("stopGiveaway").addEventListener("click", () => {
        if (!isAdmin()) return;
        state.giveawayActive = false;
        saveGiveawayState();
        renderStats();
        document.getElementById("adminStatus").textContent = "не активен";
      });
      renderStreams();
      tryRestoreTwitchToken();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
